"use strict";(self.webpackChunkdevoyage_web=self.webpackChunkdevoyage_web||[]).push([[9251],{3905:(e,t,n)=>{n.d(t,{Zo:()=>p,kt:()=>d});var a=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function o(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var l=a.createContext({}),u=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):s(s({},t),e)),n},p=function(e){var t=u(e.components);return a.createElement(l.Provider,{value:t},e.children)},c={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},h=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,i=e.originalType,l=e.parentName,p=o(e,["components","mdxType","originalType","parentName"]),h=u(n),d=r,g=h["".concat(l,".").concat(d)]||h[d]||c[d]||i;return n?a.createElement(g,s(s({ref:t},p),{},{components:n})):a.createElement(g,s({ref:t},p))}));function d(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=n.length,s=new Array(i);s[0]=h;var o={};for(var l in t)hasOwnProperty.call(t,l)&&(o[l]=t[l]);o.originalType=e,o.mdxType="string"==typeof e?e:r,s[1]=o;for(var u=2;u<i;u++)s[u]=n[u];return a.createElement.apply(null,s)}return a.createElement.apply(null,n)}h.displayName="MDXCreateElement"},8249:(e,t,n)=>{n.d(t,{U:()=>i});var a=n(7294),r=n(9960);const i=()=>a.createElement("div",{className:"alert alert--info margin-vert--lg",style:{display:"flex",justifyContent:"space-between",flexDirection:"column"}},a.createElement("div",{className:"avatar"},a.createElement("a",{className:"avatar__photo-link avatar__photo avatar__photo--lg",href:"https://medium.com/@thedevoyage"},a.createElement("img",{alt:"Nick McLean Profile Image",src:"https://cdn-images-1.medium.com/fit/c/63/63/1*TY45PiqMrWiUkivbhmp-Sw.jpeg"})),a.createElement("div",{className:"avatar__intro"},a.createElement("div",{className:"avatar__name"},"Nick McLean"),a.createElement("small",{className:"avatar__subtitle padding-bottom--md"},"Thanks for following along. If you would like to keep up to date make sure to check in frequently and/or follow us below!"),a.createElement("div",null,[{to:"https://medium.com/@thedevoyage",label:"Medium"},{to:"https://twitter.com/thedevoyage",label:"Twitter"},{to:"https://thedevoyage.slack.com",label:"Slack"},{to:"https://thedevoyage.gumroad.com/subscribe",label:"Newsletter"}].map((e=>a.createElement(r.Z,{to:e.to,key:e.to},a.createElement("button",{className:"button button--primary margin-right--md",style:{color:"#fff",backgroundColor:"var(--ifm-color-dark-blue)"}},e.label))))))))},8126:(e,t,n)=>{n.d(t,{W:()=>i});var a=n(7294),r=n(9960);const i=e=>{let{product:t,to:n,message:i,btnTxt:s}=e;return a.createElement("div",{className:"alert alert--info margin-vert--lg",style:{display:"flex",justifyContent:"space-between",alignItems:"center"}},i||a.createElement("span",null,"Want to support `@the-devoyage/",t,"`?"),a.createElement(r.Z,{to:n},a.createElement("button",{className:"button button--primary"},s||"Purchase MIT License")))}},4357:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>p,contentTitle:()=>l,default:()=>d,frontMatter:()=>o,metadata:()=>u,toc:()=>c});var a=n(7462),r=(n(7294),n(3905)),i=n(8249),s=n(8126);const o={title:"Create an Instant Passkey/Auth Server with Subgraph",slug:"passkey-auth-server-with-subgraph",authors:["nick"],tags:["subgraph","passkeys","webauthn","passkey server"],date:new Date("2024-01-01T00:00:00.000Z"),description:"Learn about and incorporate passkeys into your website in minutes with Subgraph.",image:"https://res.cloudinary.com/the-devoyage/image/upload/v1687224196/Subgraph_1_swkuzy.png",keywords:["graphql","subgraph","api","api generator","passkeys","webauthn","auth server"]},l=void 0,u={permalink:"/blog/passkey-auth-server-with-subgraph",editUrl:"https://www.github.com/The-Devoyage/devoyage-web/blob/master/blog/subgraph-as-auth/index.md",source:"@site/blog/subgraph-as-auth/index.md",title:"Create an Instant Passkey/Auth Server with Subgraph",description:"Learn about and incorporate passkeys into your website in minutes with Subgraph.",date:"2024-01-01T00:00:00.000Z",formattedDate:"January 1, 2024",tags:[{label:"subgraph",permalink:"/blog/tags/subgraph"},{label:"passkeys",permalink:"/blog/tags/passkeys"},{label:"webauthn",permalink:"/blog/tags/webauthn"},{label:"passkey server",permalink:"/blog/tags/passkey-server"}],readingTime:8.12,hasTruncateMarker:!0,authors:[{name:"Nick McLean",title:"Maintainer of The Devoyage",url:"https://medium.com/@thedevoyage",imageURL:"https://cdn-images-1.medium.com/fit/c/63/63/1*TY45PiqMrWiUkivbhmp-Sw.jpeg",key:"nick"}],frontMatter:{title:"Create an Instant Passkey/Auth Server with Subgraph",slug:"passkey-auth-server-with-subgraph",authors:["nick"],tags:["subgraph","passkeys","webauthn","passkey server"],date:"2024-01-01T00:00:00.000Z",description:"Learn about and incorporate passkeys into your website in minutes with Subgraph.",image:"https://res.cloudinary.com/the-devoyage/image/upload/v1687224196/Subgraph_1_swkuzy.png",keywords:["graphql","subgraph","api","api generator","passkeys","webauthn","auth server"]},nextItem:{title:"Subgraph v0.0.13 - Instant API Generation At Your Fingertips with Subgraph",permalink:"/blog/subgraph-v0.0.13-instant-api-at-your-fingertips"}},p={authorsImageUrls:[void 0]},c=[{value:"How Passkeys Work",id:"how-passkeys-work",level:2},{value:"Registration with Passkeys",id:"registration-with-passkeys",level:3},{value:"Authentication with Passkeys",id:"authentication-with-passkeys",level:3},{value:"Using Subgraph as an Auth Server",id:"using-subgraph-as-an-auth-server",level:2},{value:"Requirements",id:"requirements",level:3},{value:"Starting The Auth Server",id:"starting-the-auth-server",level:3},{value:"The Frontend Code",id:"the-frontend-code",level:2},{value:"Register Start",id:"register-start",level:3},{value:"Register Finish",id:"register-finish",level:3},{value:"Authenticate Start",id:"authenticate-start",level:3},{value:"Authenticate Finish",id:"authenticate-finish",level:3},{value:"What&#39;s Next?",id:"whats-next",level:2}],h={toc:c};function d(e){let{components:t,...n}=e;return(0,r.kt)("wrapper",(0,a.Z)({},h,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("p",null,"Welcome, Voyager!"),(0,r.kt)("p",null,"I am delighted to present a streamlined approach for integrating webauthn user authentication and authorization into your upcoming project."),(0,r.kt)("p",null,"In essence, we are implementing a passwordless registration and login system, offering a seamless authentication process for your users while fortifying the security of your servers."),(0,r.kt)("p",null,"Join us as we delve into the fundamentals of passkeys and explore the utilization of Subgraph as an Authentication Server for your current or prospective applications."),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"https://media4.giphy.com/media/RJDkHk2fzVQ4qu7Jif/giphy.gif?cid=ecf05e472neioas4hwda04f7er3xlchy0odkj07msehi7o4p&ep=v1_gifs_search&rid=giphy.gif&ct=g",alt:"rocketship launch"})),(0,r.kt)("p",null,"Hey... quick note - Subgraph is in a Pre-Alpha Release State! Enjoy it, build with it, and reach out with your suggested improvements! We are happy to help and listen. Lastly - Supporting working like this is also much appreciated~!"),(0,r.kt)(s.W,{product:"subgraph",to:"https://thedevoyage.gumroad.com/l/subgraph",btnTxt:"Early Alpha Release",mdxType:"LicenseAlert"}),(0,r.kt)("h2",{id:"how-passkeys-work"},"How Passkeys Work"),(0,r.kt)("p",null,"Understanding the basic flow of passkey registration and authentication is crucial to the adoption of webauthn for any web application. Let's explore the typical passkey flow for these two scenarios. Below, I'll provide a\nconcise explanation - however, it is recommended to refer to resources such as ",(0,r.kt)("a",{parentName:"p",href:"https://webauthn.guide/"},"webauthn.guide")," for more in-depth information."),(0,r.kt)("p",null,"Actions like registration and authentication typically involve two network requests to complete. This is due to the verification process between the external server and the client-side application. The majority of\nthe intricate work is managed by the browser's WebAuthN API, streamlining the communication between the applications."),(0,r.kt)("p",null,"Want to see passwordless in action? ",(0,r.kt)("a",{parentName:"p",href:"https://dev.triceratask.com"},"Triceratask")," is an application developed around Subgraph and the auth process demonstrated below! You can sign up and log in without a password."),(0,r.kt)("h3",{id:"registration-with-passkeys"},"Registration with Passkeys"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"The user initiates the registration process by providing a simple \"identifier,\" which could be an email, phone number, or username. Notably, there's no requirement for a password, and users are not constrained by special characters or minimum length criteria. A single, unique identifier suffices. Straightforward, isn't it?")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"The server verifies whether the user is eligible for registration. If permitted, it responds to the client with a \"challenge\" that aligns the server's identity with the client's registration request.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"The client application receives the challenge and leverages it to generate credentials. These credentials, however, are no ordinary passwords \u2013 they come in a pair, one private and one public. The client application concludes the registration process by providing the server with the public key for safekeeping, while retaining the private key.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"The server acknowledges the successful registration, paving the way for a seamless login experience."))),(0,r.kt)("h3",{id:"authentication-with-passkeys"},"Authentication with Passkeys"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"The user authenticates by furnishing the same identifier used during registration.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Subsequently, the server shares the public key with the client application.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Upon possessing a matching private key, the client application responds to the server with a signature of approval.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"The server receives the success message, conducts a double-check to ensure the signature matches, and reciprocates with the pertinent details \u2013 typically in the form of an authentication token."))),(0,r.kt)("h2",{id:"using-subgraph-as-an-auth-server"},"Using Subgraph as an Auth Server"),(0,r.kt)("p",null,"Today, our emphasis is on a swift and uncomplicated setup. Introducing Subgraph, a tool designed to expedite the creation of an immediate API for your data, including authentication and more!"),(0,r.kt)("h3",{id:"requirements"},"Requirements"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("strong",{parentName:"p"},"Mongo DB:")," Today's focus is on Passkeys, not the setup of a Mongo Database. I'll assume you have this already.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("strong",{parentName:"p"},"Subgraph:")," A powerful tool to generate a GraphQL backend that seamlessly manages server-side webauthn and database logic. You can ",(0,r.kt)("a",{parentName:"p",href:"https://thedevoyage.gumroad.com/l/subgraph"},"purchase a license here")," or explore the ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/The-Devoyage/subgraph/tags"},"Releases Page")," to download it for free."))),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"Your support is sincerely appreciated! Subgraph is a tool that has demanded countless hours of development. If you find value in this tutorial or benefit from using Subgraph, consider purchasing a license to express your support for this project.")),(0,r.kt)("h3",{id:"starting-the-auth-server"},"Starting The Auth Server"),(0,r.kt)("p",null,"While Subgraph can serve as a comprehensive API for all your data, today, our focus will be on utilizing it solely as an authentication server. Subgraph is remarkably user-friendly, requiring just a minute to set up and get started. The process involves creating a simple configuration file before launching the service."),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Create a file named ",(0,r.kt)("inlineCode",{parentName:"li"},"config.toml")," in the root of your project and paste the following content:")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-toml"},'[service]\nname = "my_first_auth_service"\n\n# Define a Data Source to save user information.\n[[service.data_sources]]\n[service.data_sources.Mongo]\nname = "my_mongo_db"\nuri = "mongodb://user:pass@127.0.0.1:27017/my_db_name"\ndb = "my_db_name"\n# Optionally, generate a key pair and define a set private key.\n# If omitted, subgraph generates a new private key each time it starts.\n# Generate a key pair by running `subgraph --generate-keypair`\n# private_key = "paste_private_key_here"\n\n# Enable the auth service by providing the following options.\n[service.auth]\nrequesting_party = "localhost" # The client side domain name.\nrequesting_party_name = "demo_auth" # The name of the application.\nrequesting_party_origin = "http://localhost:8000" # The client side origin, must match domain name.\ndata_source = "users_data_source" # The data source to interact with.\n\n# An entity is a collection in Mongo or Table in SQL. Tell subgraph about the user entity.\n[[service.entities]]\nname = "user"\ndata_source = { from = "my_mongo_db", collection = "subgraph_user" }\nfields = [\n  { name = "_id", scalar = "ObjectID", required = true, exclude_from_input = ["CreateOne", "UpdateOne", "UpdateMany"]},\n  { name = "uuid", scalar = "UUID", required = true, exclude_from_input = ["CreateOne", "UpdateOne", "UpdateMany"]},\n  { name = "identifier", scalar = "String", required = true }\n]\n')),(0,r.kt)("ol",{start:2},(0,r.kt)("li",{parentName:"ol"},"Run the service with the subgraph cli.")),(0,r.kt)("p",null,"The execution might change depending on operating system or if you have placed the binary in the systems path."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"subgraph --config ./config.toml\n")),(0,r.kt)("h2",{id:"the-frontend-code"},"The Frontend Code"),(0,r.kt)("p",null,"Now that you have the auth server running, let's write some frontend example code."),(0,r.kt)("h3",{id:"register-start"},"Register Start"),(0,r.kt)("p",null,"First, send the API an identifier of which you want to register using the register start mutation."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts"},'// Create the mutation\nconst REGISTER_START = gql`\n  mutation RegisterStart($identifier: String!) {\n    register_start(identifier: $identifier)\n  }\n`;\n\n// Execute the mutation using your client of choice.\nconst response = executeMutation(REGISTER_START, {\n  identifier: "nickisyourfan",\n});\n')),(0,r.kt)("p",null,"The response object will contain signed options that the Browser's Passkey API can use\nto continue the registration process."),(0,r.kt)("h3",{id:"register-finish"},"Register Finish"),(0,r.kt)("p",null,"Once the options are received, execute the ",(0,r.kt)("inlineCode",{parentName:"p"},"REGISTER_FINISH")," mutation to finalize the registration process."),(0,r.kt)("p",null,"Before executing, build the credential using the options received from the ",(0,r.kt)("inlineCode",{parentName:"p"},"REGISTER_START")," mutation along with\nthe browsers Passkey API."),(0,r.kt)("p",null,"Some properties, as shown below, are required to be of type Int Array. The example below uses the npm library ",(0,r.kt)("inlineCode",{parentName:"p"},"js-base64"),"\nto assist with this process."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts"},'import { Base64 } from "js-base64";\n\n// Create the mutation\nconst REGISTER_FINISH = gql`\n  mutation RegisterFinish($identifier: String!, $public_key: String!) {\n    register_finish(identifier: $identifier, public_key: $public_key)\n  }\n`;\n\n//  Extract the credential creation options from the previous response.\nconst cco = response.register_start as CredentialCreationOptions;\n\n// Build the credential using the browser\'s navigator credentials api.\nconst credential = await navigator.credentials.create({\n  publicKey: {\n    ...cco.publicKey,\n    challenge: Base64.toUint8Array(\n      (cco.publicKey?.challenge as unknown) as string\n    ),\n    user: {\n      ...cco.publicKey?.user,\n      id: Base64.toUint8Array((cco.publicKey?.user?.id as unknown) as string),\n    },\n  },\n});\n\nif (credential instanceof PublicKeyCredential) {\n  // Create a credential to share with the API.\n  const jsonCredential = {\n    id: credential.id,\n    type: credential.type,\n    rawId: Base64.fromUint8Array(new Uint8Array(credential.rawId), true),\n    extensions: credential.getClientExtensionResults(),\n    response: {\n      clientDataJSON: Base64.fromUint8Array(\n        new Uint8Array(credential.response.clientDataJSON),\n        true\n      ),\n      attestationObject: Base64.fromUint8Array(\n        new Uint8Array(\n          ((credential.response as unknown) as Record<string, ArrayBuffer>)\n            .attestationObject as ArrayBuffer\n        ),\n        true\n      ),\n    },\n  };\n\n  // Execute the operation\n  const success = executeMutation(REGISTER_START, {\n    identifier: "nickisyourfan",\n    public_key: JSON.stringify(jsonCredential),\n  });\n}\n')),(0,r.kt)("p",null,'Once a successful response is received, the user may proceed to "log in" using the Authentication Process.'),(0,r.kt)("h3",{id:"authenticate-start"},"Authenticate Start"),(0,r.kt)("p",null,"First, initialize the process by sending a ",(0,r.kt)("inlineCode",{parentName:"p"},"authenticate_start")," mutation."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts"},'// Create the mutation\nexport const AUTHENTICATE_START = gql`\n  mutation AuthenticateStart($identifier: String!) {\n    authenticate_start(identifier: $identifier)\n  }\n`;\n\n// Execute the mutation using your client of choice.\nconst response = executeMutation(REGISTER_START, { identifier "nickisyourfan" });\n')),(0,r.kt)("h3",{id:"authenticate-finish"},"Authenticate Finish"),(0,r.kt)("p",null,"Use the options in the response to create a credential that is used to identify the user in the next request."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts"},'const credentialRequestOptions = (response.authenticate_start as unknown) as CredentialRequestOptions;\n\n// Create the credential using the browser\'s navigator api.\nconst credential = await navigator.credentials.get({\n  publicKey: {\n    ...credentialRequestOptions.publicKey,\n    challenge: Base64.toUint8Array(\n      (credentialRequestOptions.publicKey?.challenge as unknown) as string\n    ),\n    allowCredentials: credentialRequestOptions.publicKey?.allowCredentials?.map(\n      (c) => ({\n        ...c,\n        id: Base64.toUint8Array((c.id as unknown) as string),\n      })\n    ),\n  },\n});\n\nif (credential instanceof PublicKeyCredential) {\n  // Get the response from the credential.\n  const response = credential.response as AuthenticatorAssertionResponse;\n\n  // Build a serializable credential to send to the API.\n  const jsonCredential = {\n    id: credential.id,\n    type: credential.type,\n    rawId: Base64.fromUint8Array(new Uint8Array(credential.rawId), true),\n    extensions: credential.getClientExtensionResults(),\n    response: {\n      authenticatorData: Base64.fromUint8Array(\n        new Uint8Array(response.authenticatorData),\n        true\n      ),\n      clientDataJSON: Base64.fromUint8Array(\n        new Uint8Array(response.clientDataJSON),\n        true\n      ),\n      signature: Base64.fromUint8Array(\n        new Uint8Array(response.signature),\n        true\n      ),\n    },\n  };\n\n  // Execute the operation\n  const {\n    authenticate_finish: { user_identifier, user_uuid, token },\n  } = executeMutation(REGISTER_FINISH, {\n    identifier: "nickisyourfan",\n    public_key: JSON.stringify(jsonCredential),\n  });\n}\n')),(0,r.kt)("p",null,"After succcessfuly logging in you will receive three properties including the user's identifier, UUID, and token."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Identifier - The input provided by the user to identify their account. Usually an email or username."),(0,r.kt)("li",{parentName:"ul"},"UUID - The shareable id that can be used to identify a user."),(0,r.kt)("li",{parentName:"ul"},"Token - A signed ",(0,r.kt)("inlineCode",{parentName:"li"},"biscuit")," token, similar to a JWT, that is used to further access the API. See the biscuit rust crate for more details concerning biscuits.")),(0,r.kt)("h2",{id:"whats-next"},"What's Next?"),(0,r.kt)("p",null,'Now, you possess a token representing a user! This token bears a striking resemblance to a JWT Token; it\'s referred to as a "biscuit" from the ',(0,r.kt)("a",{parentName:"p",href:"https://www.biscuitsec.org/"},"Biscuit Auth")," library. Utilize this token seamlessly with Subgraph APIs or incorporate it into your custom implementation to validate subsequent requests, just as you would with any comparable JWT."),(0,r.kt)("p",null,"For further insights into creating fully-featured APIs or to delve deeper into the Subgraph auth API and understand how these authentication tokens can be employed to verify requests, refer to the ",(0,r.kt)("a",{parentName:"p",href:"/subgraph/intro"},"Subgraph Documentation"),"."),(0,r.kt)(i.U,{mdxType:"BlogFooter"}))}d.isMDXComponent=!0}}]);